{% extends 'base.html' %}
{% load static %}

{% block title %}–¢—Ä–µ–Ω–∞–∂–µ—Ä —Å—á–µ—Ç–∞ - HyperScript{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">üßÆ –¢—Ä–µ–Ω–∞–∂–µ—Ä —É—Å—Ç–Ω–æ–≥–æ —Å—á–µ—Ç–∞</h1>
            <p class="lead">–¢—Ä–µ–Ω–∏—Ä—É–π—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∏ —É–ª—É—á—à–∞–π—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å —Å—á–µ—Ç–∞</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary operation-btn" data-operation="addition">
                            ‚ûï –°–ª–æ–∂–µ–Ω–∏–µ
                        </button>
                        <button class="btn btn-outline-success operation-btn" data-operation="subtraction">
                            ‚ûñ –í—ã—á–∏—Ç–∞–Ω–∏–µ
                        </button>
                        <button class="btn btn-outline-warning operation-btn" data-operation="multiplication">
                            ‚úñÔ∏è –£–º–Ω–æ–∂–µ–Ω–∏–µ
                        </button>
                        <button class="btn btn-outline-info operation-btn" data-operation="division">
                            ‚ûó –î–µ–ª–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">–°–ª–æ–∂–Ω–æ—Å—Ç—å</h5>
                </div>
                <div class="card-body">
                    <select class="form-select" id="difficultySelect">
                        <option value="easy">–õ–µ–≥–∫–∞—è (1-10)</option>
                        <option value="medium">–°—Ä–µ–¥–Ω—è—è (10-50)</option>
                        <option value="hard">–°–ª–æ–∂–Ω–∞—è (50-100)</option>
                    </select>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ù–∞—á–∞—Ç—å -->
            <div class="card mt-4">
                <div class="card-body">
                    <button class="btn btn-success w-100" id="startGameBtn" disabled>
                        üöÄ –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0" id="gameTitle">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞</h5>
                </div>
                <div class="card-body text-center">
                    <div id="startPanel">
                        <div class="py-5">
                            <i class="fas fa-brain fa-5x text-muted mb-4"></i>
                            <h3>–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏?</h3>
                            <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –∏ –Ω–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É"</p>
                        </div>
                    </div>

                    <div id="gamePanel" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-3">
                                <div class="border rounded p-2">
                                    <small>–°—á–µ—Ç</small>
                                    <div class="h4 mb-0" id="score">0</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-2">
                                    <small>–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                                    <div class="h4 mb-0 text-success" id="correct">0</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-2">
                                    <small>–û—à–∏–±–∫–∏</small>
                                    <div class="h4 mb-0 text-danger" id="incorrect">0</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="border rounded p-2">
                                    <small>–í—Ä–µ–º—è</small>
                                    <div class="h4 mb-0" id="timer">60</div>
                                </div>
                            </div>
                        </div>

                        <div id="questionPanel">
                            <div class="display-4 mb-4" id="questionText">5 + 3</div>
                            <div class="row justify-content-center">
                                <div class="col-md-6">
                                    <input type="number" class="form-control form-control-lg text-center" 
                                           id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" autofocus>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-primary btn-lg" id="submitAnswer">‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                                <button class="btn btn-secondary btn-lg" id="nextQuestion" style="display: none;">‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const operationBtns = document.querySelectorAll('.operation-btn');
    const startGameBtn = document.getElementById('startGameBtn');
    const startPanel = document.getElementById('startPanel');
    const gamePanel = document.getElementById('gamePanel');
    const gameTitle = document.getElementById('gameTitle');
    const questionText = document.getElementById('questionText');
    const answerInput = document.getElementById('answerInput');
    const submitBtn = document.getElementById('submitAnswer');
    const nextBtn = document.getElementById('nextQuestion');
    
    let currentOperation = '';
    let currentQuestion = '';
    let currentAnswer = 0;
    let score = 0, correct = 0, incorrect = 0;
    let timer = 60;
    let timerInterval;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
    operationBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            operationBtns.forEach(b => b.classList.remove('active', 'btn-primary', 'btn-success', 'btn-warning', 'btn-info'));
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            this.classList.add('active');
            if (this.dataset.operation === 'addition') this.classList.add('btn-primary');
            if (this.dataset.operation === 'subtraction') this.classList.add('btn-success');
            if (this.dataset.operation === 'multiplication') this.classList.add('btn-warning');
            if (this.dataset.operation === 'division') this.classList.add('btn-info');
            
            currentOperation = this.dataset.operation;
            startGameBtn.disabled = false;
            startGameBtn.textContent = 'üöÄ –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É';
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å"
    startGameBtn.addEventListener('click', function() {
        if (!currentOperation) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é!');
            return;
        }
        
        const operationNames = {
            'addition': '–°–ª–æ–∂–µ–Ω–∏–µ',
            'subtraction': '–í—ã—á–∏—Ç–∞–Ω–∏–µ', 
            'multiplication': '–£–º–Ω–æ–∂–µ–Ω–∏–µ',
            'division': '–î–µ–ª–µ–Ω–∏–µ'
        };
        
        gameTitle.textContent = `–¢—Ä–µ–Ω–∞–∂–µ—Ä: ${operationNames[currentOperation]}`;
        startPanel.style.display = 'none';
        gamePanel.style.display = 'block';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        score = 0; correct = 0; incorrect = 0; timer = 60;
        updateStats();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        startTimer();
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å
        generateQuestion();
    });
    
    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            timer--;
            document.getElementById('timer').textContent = timer;
            
            if (timer <= 0) {
                clearInterval(timerInterval);
                endGame();
            }
        }, 1000);
    }
    
    function updateStats() {
        document.getElementById('score').textContent = score;
        document.getElementById('correct').textContent = correct;
        document.getElementById('incorrect').textContent = incorrect;
        document.getElementById('timer').textContent = timer;
    }
    
    function generateQuestion() {
        const difficulty = document.getElementById('difficultySelect').value;
        
        fetch(`/math/operation/${currentOperation}/?difficulty=${difficulty}`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                questionText.textContent = data.question;
                currentAnswer = data.answer;
                answerInput.value = '';
                answerInput.focus();
                
                submitBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ
                generateLocalQuestion();
            });
    }
    
    function generateLocalQuestion() {
        const difficulty = document.getElementById('difficultySelect').value;
        let a, b;
        
        if (difficulty === 'easy') {
            a = Math.floor(Math.random() * 10) + 1;
            b = Math.floor(Math.random() * 10) + 1;
        } else if (difficulty === 'medium') {
            a = Math.floor(Math.random() * 40) + 10;
            b = Math.floor(Math.random() * 40) + 10;
        } else {
            a = Math.floor(Math.random() * 50) + 50;
            b = Math.floor(Math.random() * 50) + 50;
        }
        
        if (currentOperation === 'addition') {
            questionText.textContent = `${a} + ${b}`;
            currentAnswer = a + b;
        } else if (currentOperation === 'subtraction') {
            const max = Math.max(a, b);
            const min = Math.min(a, b);
            questionText.textContent = `${max} - ${min}`;
            currentAnswer = max - min;
        } else if (currentOperation === 'multiplication') {
            a = Math.floor(Math.random() * 10) + 1;
            b = Math.floor(Math.random() * 10) + 1;
            questionText.textContent = `${a} √ó ${b}`;
            currentAnswer = a * b;
        } else if (currentOperation === 'division') {
            b = Math.floor(Math.random() * 10) + 1;
            a = b * (Math.floor(Math.random() * 10) + 1);
            questionText.textContent = `${a} √∑ ${b}`;
            currentAnswer = a / b;
        }
        
        answerInput.value = '';
        answerInput.focus();
        submitBtn.style.display = 'inline-block';
        nextBtn.style.display = 'none';
    }
    
    function checkAnswer() {
        const userAnswer = parseInt(answerInput.value);
        
        if (isNaN(userAnswer)) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
            return;
        }
        
        if (userAnswer === currentAnswer) {
            score += 10;
            correct++;
            questionText.innerHTML = '‚úÖ <span class="text-success">–ü—Ä–∞–≤–∏–ª—å–Ω–æ!</span>';
        } else {
            incorrect++;
            questionText.innerHTML = `‚ùå <span class="text-danger">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${currentAnswer}</span>`;
        }
        
        updateStats();
        submitBtn.style.display = 'none';
        nextBtn.style.display = 'inline-block';
    }
    
    function endGame() {
        questionText.innerHTML = `üèÅ <strong>–í—Ä–µ–º—è –≤—ã—à–ª–æ!</strong><br>–í–∞—à —Å—á–µ—Ç: ${score}`;
        answerInput.style.display = 'none';
        submitBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        saveScore();
    }
    
    function saveScore() {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        console.log('Game finished:', { score, correct, incorrect, operation: currentOperation });
    }
    
    submitBtn.addEventListener('click', checkAnswer);
    nextBtn.addEventListener('click', generateQuestion);
    answerInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') checkAnswer();
    });
});
</script>

<style>
.operation-btn.active {
    font-weight: bold;
    transform: scale(1.05);
}
</style>
{% endblock %}