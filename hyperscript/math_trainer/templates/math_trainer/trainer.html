{% extends 'base.html' %}
{% load static %}

{% block title %}–¢—Ä–µ–Ω–∞–∂–µ—Ä —Å—á–µ—Ç–∞ - HyperScript{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-brain me-2"></i>–¢—Ä–µ–Ω–∞–∂–µ—Ä —É—Å—Ç–Ω–æ–≥–æ —Å—á–µ—Ç–∞
        </h1>
        <p class="lead">–¢—Ä–µ–Ω–∏—Ä—É–π—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –∏ —É–ª—É—á—à–∞–π—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å —Å—á–µ—Ç–∞</p>
    </div>
</div>

<div class="row mt-4">
    <!-- –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary operation-btn" data-operation="addition">
                        <i class="fas fa-plus me-2"></i>–°–ª–æ–∂–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-outline-success operation-btn" data-operation="subtraction">
                        <i class="fas fa-minus me-2"></i>–í—ã—á–∏—Ç–∞–Ω–∏–µ
                    </button>
                    <button class="btn btn-outline-warning operation-btn" data-operation="multiplication">
                        <i class="fas fa-times me-2"></i>–£–º–Ω–æ–∂–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-outline-info operation-btn" data-operation="division">
                        <i class="fas fa-divide me-2"></i>–î–µ–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>

        <!-- –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-sliders-h me-2"></i>–°–ª–æ–∂–Ω–æ—Å—Ç—å
                </h5>
            </div>
            <div class="card-body">
                <select class="form-select" id="difficultySelect">
                    <option value="easy">–õ–µ–≥–∫–∞—è (1-10)</option>
                    <option value="medium">–°—Ä–µ–¥–Ω—è—è (10-50)</option>
                    <option value="hard">–°–ª–æ–∂–Ω–∞—è (50-100)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- –ò–≥—Ä–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0" id="gameTitle">
                    <i class="fas fa-play-circle me-2"></i>–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞
                </h5>
            </div>
            <div class="card-body text-center">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="row mb-4" id="statsPanel" style="display: none;">
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <small class="text-muted">–°—á–µ—Ç</small>
                            <div class="h4 mb-0" id="score">0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <small class="text-muted">–ü—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                            <div class="h4 mb-0 text-success" id="correct">0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <small class="text-muted">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ</small>
                            <div class="h4 mb-0 text-danger" id="incorrect">0</div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <small class="text-muted">–í—Ä–µ–º—è</small>
                            <div class="h4 mb-0" id="timer">60</div>
                        </div>
                    </div>
                </div>

                <!-- –í–æ–ø—Ä–æ—Å -->
                <div id="questionPanel" style="display: none;">
                    <div class="display-1 mb-4" id="questionText">5 + 3</div>
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <input type="number" class="form-control form-control-lg text-center" 
                                   id="answerInput" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç" autofocus>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-lg" id="submitAnswer">
                            <i class="fas fa-check me-2"></i>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                        <button class="btn btn-secondary btn-lg" id="nextQuestion" style="display: none;">
                            <i class="fas fa-arrow-right me-2"></i>–î–∞–ª–µ–µ
                        </button>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                <div id="resultPanel" style="display: none;">
                    <div class="alert" id="resultAlert">
                        <h4 id="resultText"></h4>
                        <p id="resultMessage"></p>
                    </div>
                    <button class="btn btn-success btn-lg" id="restartGame">
                        <i class="fas fa-redo me-2"></i>–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>

                <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω -->
                <div id="startPanel">
                    <div class="py-5">
                        <i class="fas fa-brain fa-5x text-muted mb-4"></i>
                        <h3>–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –Ω–∞–≤—ã–∫–∏?</h3>
                        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –≤—ã—à–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class MathTrainer {
    constructor() {
        this.score = 0;
        this.correct = 0;
        this.incorrect = 0;
        this.timeLeft = 60;
        this.timer = null;
        this.currentOperation = null;
        this.currentQuestion = null;
        this.currentAnswer = null;
        this.isGameActive = false;
        
        this.initializeEventListeners();
    }
    
    initializeEventListeners() {
        // –ö–Ω–æ–ø–∫–∏ –æ–ø–µ—Ä–∞—Ü–∏–π
        document.querySelectorAll('.operation-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.startGame(e.target.dataset.operation);
            });
        });
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
        document.getElementById('submitAnswer').addEventListener('click', () => {
            this.checkAnswer();
        });
        
        // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        document.getElementById('nextQuestion').addEventListener('click', () => {
            this.nextQuestion();
        });
        
        // –†–µ—Å—Ç–∞—Ä—Ç –∏–≥—Ä—ã
        document.getElementById('restartGame').addEventListener('click', () => {
            this.restartGame();
        });
        
        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
        document.getElementById('answerInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.checkAnswer();
            }
        });
    }
    
    async startGame(operation) {
        this.currentOperation = operation;
        this.resetGame();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤—É—é –ø–∞–Ω–µ–ª—å
        document.getElementById('startPanel').style.display = 'none';
        document.getElementById('statsPanel').style.display = 'flex';
        document.getElementById('questionPanel').style.display = 'block';
        document.getElementById('resultPanel').style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const operationNames = {
            'addition': '–°–ª–æ–∂–µ–Ω–∏–µ',
            'subtraction': '–í—ã—á–∏—Ç–∞–Ω–∏–µ', 
            'multiplication': '–£–º–Ω–æ–∂–µ–Ω–∏–µ',
            'division': '–î–µ–ª–µ–Ω–∏–µ'
        };
        document.getElementById('gameTitle').innerHTML = 
            `<i class="fas fa-play-circle me-2"></i>${operationNames[operation]}`;
        
        this.isGameActive = true;
        this.startTimer();
        await this.nextQuestion();
    }
    
    async nextQuestion() {
        if (!this.isGameActive) return;
        
        const difficulty = document.getElementById('difficultySelect').value;
        
        try {
            const response = await fetch(`/math/operation/${this.currentOperation}/?difficulty=${difficulty}`);
            const data = await response.json();
            
            this.currentQuestion = data.question;
            this.currentAnswer = data.answer;
            
            document.getElementById('questionText').textContent = this.currentQuestion;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
            
            document.getElementById('submitAnswer').style.display = 'inline-block';
            document.getElementById('nextQuestion').style.display = 'none';
            
        } catch (error) {
            console.error('Error fetching question:', error);
        }
    }
    
    checkAnswer() {
        const userAnswer = parseInt(document.getElementById('answerInput').value);
        
        if (isNaN(userAnswer)) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ');
            return;
        }
        
        if (userAnswer === this.currentAnswer) {
            this.score += 10;
            this.correct++;
            this.showResult(true, '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ');
        } else {
            this.incorrect++;
            this.showResult(false, `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${this.currentAnswer}`);
        }
        
        this.updateStats();
        
        document.getElementById('submitAnswer').style.display = 'none';
        document.getElementById('nextQuestion').style.display = 'inline-block';
    }
    
    showResult(isCorrect, message) {
        const alert = document.getElementById('resultAlert');
        const resultText = document.getElementById('resultText');
        const resultMessage = document.getElementById('resultMessage');
        
        if (isCorrect) {
            alert.className = 'alert alert-success';
            resultText.innerHTML = '<i class="fas fa-check-circle me-2"></i>–í–µ—Ä–Ω–æ!';
        } else {
            alert.className = 'alert alert-danger'; 
            resultText.innerHTML = '<i class="fas fa-times-circle me-2"></i>–ù–µ–≤–µ—Ä–Ω–æ!';
        }
        
        resultMessage.textContent = message;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('questionPanel').style.display = 'none';
        document.getElementById('resultPanel').style.display = 'block';
    }
    
    updateStats() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('correct').textContent = this.correct;
        document.getElementById('incorrect').textContent = this.incorrect;
    }
    
    startTimer() {
        this.timeLeft = 60;
        document.getElementById('timer').textContent = this.timeLeft;
        
        this.timer = setInterval(() => {
            this.timeLeft--;
            document.getElementById('timer').textContent = this.timeLeft;
            
            if (this.timeLeft <= 0) {
                this.endGame();
            }
        }, 1000);
    }
    
    endGame() {
        this.isGameActive = false;
        clearInterval(this.timer);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        this.saveScore();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        document.getElementById('questionPanel').style.display = 'none';
        document.getElementById('resultPanel').style.display = 'block';
        
        const accuracy = this.correct + this.incorrect > 0 ? 
            (this.correct / (this.correct + this.incorrect)) * 100 : 0;
            
        document.getElementById('resultAlert').className = 'alert alert-info';
        document.getElementById('resultText').innerHTML = 
            '<i class="fas fa-flag-checkered me-2"></i>–í—Ä–µ–º—è –≤—ã—à–ª–æ!';
        document.getElementById('resultMessage').innerHTML = `
            <strong>–ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç:</strong> ${this.score}<br>
            <strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤:</strong> ${this.correct}<br>
            <strong>–¢–æ—á–Ω–æ—Å—Ç—å:</strong> ${accuracy.toFixed(1)}%<br>
            <strong>–í—Ä–µ–º—è:</strong> 60 —Å–µ–∫—É–Ω–¥
        `;
    }
    
    async saveScore() {
        try {
            const response = await fetch('/math/save-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    operation: this.currentOperation,
                    difficulty: document.getElementById('difficultySelect').value,
                    score: this.score,
                    total_questions: this.correct + this.incorrect,
                    correct_answers: this.correct,
                    time_spent: 60 - this.timeLeft
                })
            });
        } catch (error) {
            console.error('Error saving score:', error);
        }
    }
    
    resetGame() {
        this.score = 0;
        this.correct = 0;
        this.incorrect = 0;
        this.timeLeft = 60;
        this.updateStats();
        
        if (this.timer) {
            clearInterval(this.timer);
        }
    }
    
    restartGame() {
        this.startGame(this.currentOperation);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    window.mathTrainer = new MathTrainer();
});
</script>
{% endblock %}