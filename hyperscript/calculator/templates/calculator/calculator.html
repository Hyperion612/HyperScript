{% extends 'base.html' %}

{% block title %}–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ü–µ–Ω–æ–∫ - Study Assistant{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ü–µ–Ω–æ–∫</h1>
    
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">–†–∞—Å—Å—á–∏—Ç–∞–π —Å–≤–æ–π —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</h5>
                </div>
                <div class="card-body">
                    <form id="gradeForm">
                        {% csrf_token %}
                        <div id="gradesContainer">
                            <div class="grade-row row mb-2">
                                <div class="col-md-6">
                                    <select name="grades[]" class="form-select">
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</option>
                                        <option value="5">5 - –û—Ç–ª–∏—á–Ω–æ</option>
                                        <option value="4">4 - –•–æ—Ä–æ—à–æ</option>
                                        <option value="3">3 - –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                                        <option value="2">2 - –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="number" name="weights[]" class="form-control" placeholder="–í–µ—Å" min="0.1" step="0.1" value="1">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm remove-grade" disabled>üóë</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" id="addGrade" class="btn btn-outline-primary btn-sm">+ –î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</button>
                    </form>
                    
                    <div id="result" class="mt-3" style="display: none;">
                        <div class="alert alert-success">
                            <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h5>
                            <p id="resultText"></p>
                        </div>
                    </div>
                    
                    <div id="error" class="mt-3" style="display: none;">
                        <div class="alert alert-danger">
                            <p id="errorText"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</h6>
                    <ul class="small">
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 2 –¥–æ 5</li>
                        <li>–£–∫–∞–∂–∏—Ç–µ –≤–µ—Å –æ—Ü–µ–Ω–∫–∏ (–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è - 2, –¥–æ–º–∞—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ - 1)</li>
                        <li>–î–æ–±–∞–≤—å—Ç–µ –≤—Å–µ —Å–≤–æ–∏ –æ—Ü–µ–Ω–∫–∏</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∞–ª–ª–∞</li>
                    </ul>
                    <div class="mt-2">
                        <strong>–°–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–æ–∫:</strong>
                        <ul class="small mb-0">
                            <li>5 - –û—Ç–ª–∏—á–Ω–æ</li>
                            <li>4 - –•–æ—Ä–æ—à–æ</li>
                            <li>3 - –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</li>
                            <li>2 - –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const gradesContainer = document.getElementById('gradesContainer');
    const addButton = document.getElementById('addGrade');
    const form = document.getElementById('gradeForm');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –æ—Ü–µ–Ω–∫–∏
    addButton.addEventListener('click', function() {
        const newRow = document.createElement('div');
        newRow.className = 'grade-row row mb-2';
        newRow.innerHTML = `
            <div class="col-md-6">
                <select name="grades[]" class="form-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É</option>
                    <option value="5">5 - –û—Ç–ª–∏—á–Ω–æ</option>
                    <option value="4">4 - –•–æ—Ä–æ—à–æ</option>
                    <option value="3">3 - –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                    <option value="2">2 - –ù–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="number" name="weights[]" class="form-control" placeholder="–í–µ—Å" min="0.1" step="0.1" value="1">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm remove-grade">üóë</button>
            </div>
        `;
        gradesContainer.appendChild(newRow);
        updateRemoveButtons();
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    function updateRemoveButtons() {
        const removeButtons = document.querySelectorAll('.remove-grade');
        removeButtons.forEach(btn => {
            btn.disabled = document.querySelectorAll('.grade-row').length === 1;
            btn.onclick = function() {
                if (document.querySelectorAll('.grade-row').length > 1) {
                    this.closest('.grade-row').remove();
                    updateRemoveButtons();
                }
            };
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                document.getElementById('resultText').innerHTML = 
                    `<strong>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª: ${data.average_grade}</strong><br>
                     <strong>–ö–∞—á–µ—Å—Ç–≤–æ: ${data.qualitative_grade}</strong><br>
                     –û–±—â–∏–π –≤–µ—Å: ${data.total_weight}`;
            } else {
                errorDiv.style.display = 'block';
                resultDiv.style.display = 'none';
                document.getElementById('errorText').textContent = data.error;
            }
        })
        .catch(error => {
            errorDiv.style.display = 'block';
            resultDiv.style.display = 'none';
            document.getElementById('errorText').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ';
        });
    });
    
    updateRemoveButtons();
});
</script>

<style>
.grade-row {
    align-items: center;
}
.remove-grade:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}