{% extends 'base.html' %}

{% block title %}–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä - HyperScript{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä</h1>
    
    <div class="row">
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ *</label>
                            <input type="text" name="title" class="form-control" required maxlength="200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                            <input type="text" name="artist" class="form-control" maxlength="200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ê—É–¥–∏–æ —Ñ–∞–π–ª *</label>
                            <input type="file" name="audio_file" class="form-control" accept="audio/*" required>
                            <div class="form-text">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: MP3, WAV, OGG</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–æ–º -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–µ–µ—Ä–æ–º</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button onclick="toggleRepeat()" class="btn btn-outline-info btn-sm">
                            üîÅ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –ø–æ–≤—Ç–æ—Ä
                        </button>
                        <button onclick="stopGlobalPlayback()" class="btn btn-outline-danger btn-sm">
                            ‚úñ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
                        </button>
                        <button onclick="playPauseAudio()" class="btn btn-outline-success btn-sm" id="globalPlayPauseBtn">
                            ‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏/–ü–∞—É–∑–∞
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            üí° –ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! –ù–∞–∂–º–∏—Ç–µ "–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üé∂ –ú–æ—è –º—É–∑—ã–∫–∞</h5>
                    <span class="badge bg-primary">{{ tracks.count }} —Ç—Ä–µ–∫–æ–≤</span>
                </div>
                <div class="card-body">
                    {% if tracks %}
                        <div class="list-group">
                            {% for track in tracks %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ track.title }}</h6>
                                        <small class="text-muted">
                                            {% if track.artist %}{{ track.artist }} ‚Ä¢ {% endif %}
                                            {{ track.uploaded_at|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                    <div class="btn-group ms-3">
                                        <button onclick="prepareTrack('{{ track.audio_file.url }}', '{{ track.title }}')" 
                                                class="btn btn-sm btn-success">‚ñ∂ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å</button>
                                        <button onclick="playPreparedTrack()" 
                                                class="btn btn-sm btn-primary">üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                                        <a href="{% url 'delete_track' track.id %}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–∫ &quot;{{ track.title }}&quot;?')">üóë –£–¥–∞–ª–∏—Ç—å</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="h1 text-muted mb-3">üéµ</div>
                            <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º—É–∑—ã–∫–∏</p>
                            <p class="text-muted small">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–ª—É—à–∞—Ç—å –º—É–∑—ã–∫—É</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–µ–µ—Ä–µ -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6>üéß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–ª–µ–µ—Ä</h6>
                    <ul class="small mb-0">
                        <li><strong>‚ñ∂ –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å</strong> - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç—Ä–µ–∫ –≤ –ø–ª–µ–µ—Ä</li>
                        <li><strong>üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</strong> - –Ω–∞—á–∏–Ω–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</li>
                        <li><strong>üîÅ –ü–æ–≤—Ç–æ—Ä</strong> - –∑–∞—Ü–∏–∫–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫</li>
                        <li>–ú—É–∑—ã–∫–∞ –∏–≥—Ä–∞–µ—Ç –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö</li>
                        <li>–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞–º–∏
let currentTrackUrl = '';
let currentTrackTitle = '';

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç—Ä–µ–∫–∞ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é (–±–µ–∑ –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)
function prepareTrack(audioUrl, trackTitle) {
    currentTrackUrl = audioUrl;
    currentTrackTitle = trackTitle;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–∫ –≤ –ø–ª–µ–µ—Ä
    if (window.playGlobal) {
        window.playGlobal(audioUrl, trackTitle);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showNotification(`–¢—Ä–µ–∫ "${trackTitle}" –≥–æ—Ç–æ–≤ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é`, 'success');
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
function playPreparedTrack() {
    if (currentTrackUrl && window.playPauseAudio) {
        // –°–Ω–∞—á–∞–ª–∞ —É–±–µ–¥–∏–º—Å—è —á—Ç–æ —Ç—Ä–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω
        if (window.globalAudio && window.globalAudio.src === currentTrackUrl) {
            window.playPauseAudio();
        } else {
            // –ï—Å–ª–∏ —Ç—Ä–µ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
            prepareTrack(currentTrackUrl, currentTrackTitle);
            setTimeout(() => {
                if (window.playPauseAudio) {
                    window.playPauseAudio();
                }
            }, 500);
        }
    } else {
        showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Ç—Ä–µ–∫', 'warning');
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
function updateGlobalPlayButton() {
    const globalBtn = document.getElementById('globalPlayPauseBtn');
    if (globalBtn && window.globalAudio) {
        if (window.globalAudio.paused || !window.globalAudio.src) {
            globalBtn.textContent = '‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏';
            globalBtn.className = globalBtn.className.replace('btn-warning', 'btn-success');
        } else {
            globalBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
            globalBtn.className = globalBtn.className.replace('btn-success', 'btn-warning');
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateGlobalPlayButton, 1000);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–µ–µ—Ä–∞
    if (window.globalAudio && window.globalAudio.src) {
        showNotification('–ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.', 'info');
    }
});
</script>

<style>
.list-group-item {
    border: 1px solid rgba(0,0,0,.125);
    margin-bottom: 0.5rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
}
.list-group-item:hover {
    background-color: #f8f9fa;
}
.btn-group .btn {
    margin-left: 0.25rem;
}
</style>
{% endblock %}