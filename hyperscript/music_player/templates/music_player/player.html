{% extends 'base.html' %}

{% block title %}–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä - HyperScript{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä</h1>
    
    <!-- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –ø–ª–µ–µ—Ä (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–Ω–∏–∑—É) -->
    <div id="globalPlayer" class="card fixed-bottom mb-3 mx-3" style="display: none;">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <strong id="nowPlaying">–ù–µ –∏–≥—Ä–∞–µ—Ç</strong>
                </div>
                <div class="col-md-6">
                    <audio id="globalAudio" controls class="w-100">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã.
                    </audio>
                </div>
                <div class="col-md-2 text-end">
                    <button onclick="stopGlobalPlayback()" class="btn btn-sm btn-danger">‚úñ –°—Ç–æ–ø</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏ -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</label>
                            {{ form.title }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                            {{ form.artist }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ê—É–¥–∏–æ —Ñ–∞–π–ª</label>
                            {{ form.audio_file }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üé∂ –ú–æ—è –º—É–∑—ã–∫–∞</h5>
                </div>
                <div class="card-body">
                    {% if tracks %}
                        <div class="list-group">
                            {% for track in tracks %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ track.title }}</h6>
                                        <small class="text-muted">
                                            {% if track.artist %}{{ track.artist }} ‚Ä¢ {% endif %}
                                            {{ track.uploaded_at|date:"d.m.Y" }}
                                        </small>
                                    </div>
                                    <div>
                                        <button onclick="playGlobal('{{ track.audio_file.url }}', '{{ track.title }}')" 
                                                class="btn btn-sm btn-success">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
                                        <a href="{% url 'delete_track' track.id %}" 
                                           class="btn btn-sm btn-danger"
                                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–µ–∫?')">üóë –£–¥–∞–ª–∏—Ç—å</a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º—É–∑—ã–∫–∏</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let globalAudio = document.getElementById('globalAudio');
let globalPlayer = document.getElementById('globalPlayer');
let nowPlaying = document.getElementById('nowPlaying');

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–ª–µ–µ—Ä–µ
function playGlobal(audioUrl, trackTitle) {
    globalAudio.src = audioUrl;
    globalAudio.play();
    nowPlaying.textContent = `–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: ${trackTitle}`;
    globalPlayer.style.display = 'block';
}

// –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
function stopGlobalPlayback() {
    globalAudio.pause();
    globalAudio.currentTime = 0;
    globalPlayer.style.display = 'none';
    nowPlaying.textContent = '–ù–µ –∏–≥—Ä–∞–µ—Ç';
}

// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–ª–µ–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && globalAudio.src && !globalAudio.paused) {
        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞
        globalAudio.play().catch(e => console.log('Auto-play prevented'));
    }
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
globalAudio.addEventListener('play', function() {
    localStorage.setItem('currentTrack', globalAudio.src);
    localStorage.setItem('currentTime', globalAudio.currentTime);
});

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const savedTrack = localStorage.getItem('currentTrack');
    const savedTime = localStorage.getItem('currentTime');
    
    if (savedTrack) {
        globalAudio.src = savedTrack;
        globalAudio.currentTime = parseFloat(savedTime) || 0;
        globalPlayer.style.display = 'block';
        nowPlaying.textContent = '–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)';
    }
});
</script>

<style>
.fixed-bottom {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}