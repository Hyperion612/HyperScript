{% extends 'base.html' %}

{% block title %}–í–∏—Å–µ–ª–∏—Ü–∞ - HyperScript{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">üéÆ –í–∏—Å–µ–ª–∏—Ü–∞</h3>
                    <div class="float-end">
                        <span class="badge bg-danger">–°–ª–æ–≤–æ: {{ word_length }} –±—É–∫–≤</span>
                    </div>
                </div>
                
                <div class="card-body text-center" id="gameContainer">
                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ AJAX -->
                    {% include 'games/hangman_game.html' %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è AJAX -->
<script>
// CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// –§—É–Ω–∫—Ü–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≤–∏—Å–µ–ª–∏—Ü—ã
function drawHangman(wrongGuesses) {
    const parts = [
        wrongGuesses > 0 ? 'O' : ' ',
        wrongGuesses > 1 ? '|' : ' ',
        wrongGuesses > 2 ? '/' : ' ',
        wrongGuesses > 3 ? '\\' : ' ',
        wrongGuesses > 4 ? '/' : ' ',
        wrongGuesses > 5 ? '\\' : ' '
    ];
    
    return `
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ     ${parts[0]}
  ‚îÇ    ${parts[2]}${parts[1]}${parts[3]}
  ‚îÇ    ${parts[4]} ${parts[5]}
  ‚îÇ
‚îå‚îÄ‚î¥‚îÄ‚îê
    `;
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—É–∫–≤—ã
function guessLetter(letter) {
    console.log('–£–≥–∞–¥—ã–≤–∞–µ–º –±—É–∫–≤—É:', letter);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const button = document.querySelector(`[data-letter="${letter}"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch('/games/hangman/guess/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            letter: letter
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
        updateGameState(data);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (data.message) {
            showNotification(data.message, data.game_over ? 'danger' : 'success');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.disabled = false;
            button.textContent = letter;
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã
function newHangmanGame() {
    fetch('/games/hangman/new/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        updateGameState(data);
        showNotification('–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!', 'success');
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π –∏–≥—Ä—ã', 'danger');
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
function updateGameState(data) {
    const container = document.getElementById('gameContainer');
    if (!container) return;
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = data.html;
    
    // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    container.innerHTML = tempDiv.innerHTML;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    initHangmanGame();
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const container = document.getElementById('gameContainer');
    if (container) {
        container.insertBefore(notification, container.firstChild);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(notification);
            bsAlert.close();
        }, 3000);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
function initHangmanGame() {
    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –±—É–∫–≤
    document.querySelectorAll('.btn-letter:not(.disabled)').forEach(btn => {
        const letter = btn.dataset.letter;
        if (letter) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                guessLetter(letter);
            });
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏–∏
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
            this.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
    const newGameBtn = document.getElementById('newGameBtn');
    if (newGameBtn) {
        newGameBtn.addEventListener('click', function(e) {
            e.preventDefault();
            newHangmanGame();
        });
    }
    
    // –†–∏—Å—É–µ–º –≤–∏—Å–µ–ª–∏—Ü—É
    const wrongGuesses = parseInt(document.getElementById('hangmanArt')?.dataset.wrongGuesses) || 0;
    const artElement = document.getElementById('hangmanArt');
    if (artElement) {
        artElement.textContent = drawHangman(wrongGuesses);
    }
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', initHangmanGame);
</script>

<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏ */
.letter-spacing { letter-spacing: 12px; font-weight: bold; }
.btn-letter { width: 50px; height: 50px; font-weight: bold; transition: all 0.2s; }
.btn-letter:hover:not(.disabled) { transform: scale(1.1); }
.btn-letter.disabled { opacity: 0.5; cursor: not-allowed; }

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —É–≥–∞–¥—ã–≤–∞–Ω–∏—è –±—É–∫–≤—ã */
@keyframes letterGuessed {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.letter-guessed {
    animation: letterGuessed 0.3s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.alert {
    border-radius: 10px;
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .letter-spacing { letter-spacing: 6px; font-size: 1.8rem; }
    .btn-letter { width: 40px; height: 40px; font-size: 0.9rem; }
}
</style>
{% endblock %}