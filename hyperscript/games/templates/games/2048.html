{% extends 'base.html' %}

{% block title %}2048 - HyperScript{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">üéÆ 2048</h3>
                    <div class="float-end">
                        <span class="badge bg-warning">–¶–µ–ª—å: 2048</span>
                    </div>
                </div>
                
                <div class="card-body">
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 text-center bg-light">
                                <small>–°—á–µ—Ç</small>
                                <div class="h3 mb-0 text-primary">{{ score }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 text-center bg-light">
                                <small>–†–µ–∫–æ—Ä–¥</small>
                                <div class="h3 mb-0 text-warning">{{ high_score }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 text-center bg-light">
                                <small>–•–æ–¥—ã</small>
                                <div class="h3 mb-0 text-info">{{ moves }}</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if won and not game_over %}
                        <div class="alert alert-success mb-4">
                            <h4>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 2048!</h4>
                            <p class="mb-0">–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Å—á–µ—Ç!</p>
                        </div>
                    {% endif %}
                    
                    {% if game_over %}
                        <div class="alert alert-danger mb-4">
                            <h4>üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!</h4>
                            <p class="mb-0">–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤. –í–∞—à —Å—á–µ—Ç: {{ score }}</p>
                        </div>
                    {% endif %}
                    
                    <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
                    <div class="game-board mb-4">
                        <div class="grid-container">
                            {% for row in grid %}
                            <div class="grid-row">
                                {% for cell in row %}
                                <div class="grid-cell">
                                    <div class="tile tile-{{ cell }} {% if cell != 0 %}tile-show{% endif %}">
                                        {% if cell != 0 %}
                                            {{ cell }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
                    <div class="mb-4">
                        {% if not game_over %}
                        <div class="text-center mb-3">
                            <h5>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h5>
                            <div class="d-flex flex-column align-items-center">
                                <!-- –í–≤–µ—Ä—Ö -->
                                <div class="mb-2">
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="direction" value="up">
                                        <button type="submit" class="btn btn-outline-primary btn-control">
                                            ‚Üë –í–≤–µ—Ä—Ö
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- –í–ª–µ–≤–æ –∏ –≤–ø—Ä–∞–≤–æ -->
                                <div class="d-flex mb-2">
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="direction" value="left">
                                        <button type="submit" class="btn btn-outline-primary btn-control me-2">
                                            ‚Üê –í–ª–µ–≤–æ
                                        </button>
                                    </form>
                                    
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="direction" value="right">
                                        <button type="submit" class="btn btn-outline-primary btn-control">
                                            –í–ø—Ä–∞–≤–æ ‚Üí
                                        </button>
                                    </form>
                                </div>
                                
                                <!-- –í–Ω–∏–∑ -->
                                <div>
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="direction" value="down">
                                        <button type="submit" class="btn btn-outline-primary btn-control">
                                            ‚Üì –í–Ω–∏–∑
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π -->
                        <div class="text-center">
                            <form method="POST" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="new_game" value="1">
                                <button type="submit" class="btn btn-success btn-lg">
                                    üöÄ –ù–æ–≤–∞—è –∏–≥—Ä–∞
                                </button>
                            </form>
                            
                            <a href="{% url 'games_index' %}" class="btn btn-outline-secondary btn-lg ms-2">
                                ‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º
                            </a>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
                    <div class="alert alert-info">
                        <h5>üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</h5>
                        <ul class="mb-0">
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–ª–∏—Ç–æ–∫</li>
                            <li>–ü—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏ –¥–≤—É—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–ª–∏—Ç–æ–∫ –æ–Ω–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω—É</li>
                            <li>–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ö–æ–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–ª–∏—Ç–∫–∞ (2 –∏–ª–∏ 4)</li>
                            <li>–¶–µ–ª—å: —Å–æ–∑–¥–∞—Ç—å –ø–ª–∏—Ç–∫—É —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º <strong>2048</strong></li>
                            <li>–ò–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤</li>
                        </ul>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è */
.game-board {
    background: #bbada0;
    border-radius: 10px;
    padding: 15px;
    margin: 0 auto;
    max-width: 500px;
}

.grid-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.grid-row {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.grid-cell {
    width: 100px;
    height: 100px;
    background: rgba(238, 228, 218, 0.35);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.tile {
    width: 100%;
    height: 100%;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    color: #776e65;
    opacity: 0;
    transition: all 0.15s ease;
    position: absolute;
    top: 0;
    left: 0;
}

.tile-show {
    opacity: 1;
    transform: scale(1);
    animation: appear 0.2s ease;
}

@keyframes appear {
    0% { opacity: 0; transform: scale(0.5); }
    100% { opacity: 1; transform: scale(1); }
}

/* –¶–≤–µ—Ç–∞ –ø–ª–∏—Ç–æ–∫ */
.tile-2 { 
    background: #eee4da; 
    font-size: 2.2rem;
}
.tile-4 { 
    background: #ede0c8; 
    font-size: 2.2rem;
}
.tile-8 { 
    background: #f2b179; 
    color: #f9f6f2;
    font-size: 2rem;
}
.tile-16 { 
    background: #f59563; 
    color: #f9f6f2;
    font-size: 1.9rem;
}
.tile-32 { 
    background: #f67c5f; 
    color: #f9f6f2;
    font-size: 1.9rem;
}
.tile-64 { 
    background: #f65e3b; 
    color: #f9f6f2;
    font-size: 1.8rem;
}
.tile-128 { 
    background: #edcf72; 
    color: #f9f6f2; 
    font-size: 1.7rem;
    box-shadow: 0 0 10px rgba(237, 207, 114, 0.5);
}
.tile-256 { 
    background: #edcc61; 
    color: #f9f6f2; 
    font-size: 1.7rem;
    box-shadow: 0 0 10px rgba(237, 204, 97, 0.5);
}
.tile-512 { 
    background: #edc850; 
    color: #f9f6f2; 
    font-size: 1.7rem;
    box-shadow: 0 0 10px rgba(237, 200, 80, 0.5);
}
.tile-1024 { 
    background: #edc53f; 
    color: #f9f6f2; 
    font-size: 1.5rem;
    box-shadow: 0 0 15px rgba(237, 197, 63, 0.5);
}
.tile-2048 { 
    background: #edc22e; 
    color: #f9f6f2; 
    font-size: 1.5rem;
    box-shadow: 0 0 20px rgba(237, 194, 46, 0.7);
}
.tile-4096 { 
    background: #3c3a32; 
    color: #f9f6f2; 
    font-size: 1.4rem;
}
.tile-8192 { 
    background: #202020; 
    color: #f9f6f2; 
    font-size: 1.4rem;
}

/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.btn-control {
    padding: 12px 25px;
    font-size: 1.1rem;
    margin: 5px;
    min-width: 120px;
    transition: all 0.2s ease;
    border-radius: 8px;
}

.btn-control:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .game-board {
        padding: 10px;
        max-width: 100%;
    }
    
    .grid-cell {
        width: 70px;
        height: 70px;
    }
    
    .tile {
        font-size: 1.5rem;
    }
    
    .tile-2, .tile-4 {
        font-size: 1.6rem;
    }
    
    .tile-8, .tile-16, .tile-32 {
        font-size: 1.4rem;
    }
    
    .tile-64, .tile-128, .tile-256, .tile-512 {
        font-size: 1.3rem;
    }
    
    .tile-1024, .tile-2048, .tile-4096, .tile-8192 {
        font-size: 1.1rem;
    }
    
    .btn-control {
        padding: 10px 15px;
        min-width: 90px;
        font-size: 0.9rem;
    }
    
    .btn-lg {
        padding: 10px 20px;
        font-size: 1rem;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes merge {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.tile-merged {
    animation: merge 0.3s ease;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –ø–ª–∏—Ç–æ–∫ */
.tile-new {
    animation: newTile 0.4s ease;
}

@keyframes newTile {
    0% { opacity: 0; transform: scale(0); }
    50% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}
</style>

<!-- JavaScript –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéÆ –ò–≥—Ä–∞ 2048 –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    const gameData = document.getElementById('gameData2048');
    const moves = parseInt(gameData.dataset.moves) || 0;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–ª–∏—Ç–∫–∞–º
    const tiles = document.querySelectorAll('.tile-show');
    tiles.forEach((tile, index) => {
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è
        tile.style.animationDelay = (index * 0.05) + 's';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
        tile.classList.add('tile-new');
        
        // –ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ –±–æ–ª—å—à–∞—è (128+), –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ä—Ü–∞–Ω–∏–µ
        const value = parseInt(tile.textContent);
        if (value >= 128) {
            tile.style.animation = 'appear 0.2s ease, pulse 2s infinite';
        }
    });
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.btn-control').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    document.addEventListener('keydown', function(e) {
        let direction = null;
        
        switch(e.key) {
            case 'ArrowUp':
            case 'w':
            case '—Ü':
                direction = 'up';
                break;
            case 'ArrowDown':
            case 's':
            case '—ã':
                direction = 'down';
                break;
            case 'ArrowLeft':
            case 'a':
            case '—Ñ':
                direction = 'left';
                break;
            case 'ArrowRight':
            case 'd':
            case '–≤':
                direction = 'right';
                break;
        }
        
        if (direction) {
            e.preventDefault();
            // –ù–∞—Ö–æ–¥–∏–º –∏ –∫–ª–∏–∫–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
            const button = document.querySelector(`input[value="${direction}"]`)?.closest('button');
            if (button) {
                button.click();
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 100);
            }
        }
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    setTimeout(() => {
        if (moves === 0) {
            console.log('üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
            
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            const hint = document.createElement('div');
            hint.className = 'alert alert-info mt-3';
            hint.innerHTML = `
                <small>
                    üí° <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
                    <br>‚Ä¢ <kbd>‚Üê</kbd> <kbd>‚Üë</kbd> <kbd>‚Üí</kbd> <kbd>‚Üì</kbd> - —Å—Ç—Ä–µ–ª–∫–∏
                    <br>‚Ä¢ <kbd>W</kbd> <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd> - WASD
                </small>
            `;
            
            const rulesSection = document.querySelector('.alert-info');
            if (rulesSection) {
                rulesSection.parentNode.insertBefore(hint, rulesSection.nextSibling);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    hint.style.opacity = '0';
                    hint.style.transition = 'opacity 0.5s';
                    setTimeout(() => hint.remove(), 500);
                }, 10000);
            }
        }
    }, 1000);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    function playSound(effect) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–∏ –ø–æ–∑–∂–µ
        console.log('üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞:', effect);
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–ª–∏—Ç–∫–∞–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    document.querySelectorAll('.tile-show').forEach(tile => {
        tile.addEventListener('click', function() {
            console.log('üß± –ü–ª–∏—Ç–∫–∞:', this.textContent, '–¶–≤–µ—Ç:', this.style.backgroundColor);
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –±–æ–ª—å—à–∏—Ö –ø–ª–∏—Ç–æ–∫
function addPulseAnimation() {
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(255,255,255,0.3); }
            50% { box-shadow: 0 0 20px rgba(255,255,255,0.7); }
            100% { box-shadow: 0 0 5px rgba(255,255,255,0.3); }
        }
        
        .tile-128, .tile-256, .tile-512, .tile-1024, .tile-2048 {
            animation: pulse 2s infinite;
        }
    `;
    document.head.appendChild(style);
}

// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø—É–ª—å—Å–∞—Ü–∏–∏
addPulseAnimation();
</script>

{% endblock %}