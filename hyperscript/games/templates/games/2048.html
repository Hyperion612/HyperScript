{% extends 'base.html' %}

{% block title %}2048 - HyperScript{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">üéÆ 2048</h3>
                    <div class="float-end">
                        <span class="badge bg-warning">–¶–µ–ª—å: 2048</span>
                    </div>
                </div>
                
                <div class="card-body" id="gameContainer2048">
                    <!-- –ò–≥—Ä–æ–≤–∞—è —á–∞—Å—Ç—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ AJAX -->
                    {% include 'games/2048_game.html' %}
                </div>
            </div>
            
            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫–∏ -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="mb-4">
                        {% if not game_over %}
                        <div class="text-center mb-3">
                            <h5>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h5>
                            <div class="d-flex flex-column align-items-center">
                                <!-- –í–≤–µ—Ä—Ö -->
                                <div class="mb-2">
                                    <button type="button" class="btn btn-outline-primary btn-control" onclick="makeMove('up')">
                                        ‚Üë –í–≤–µ—Ä—Ö
                                    </button>
                                </div>
                                
                                <!-- –í–ª–µ–≤–æ –∏ –≤–ø—Ä–∞–≤–æ -->
                                <div class="d-flex mb-2">
                                    <button type="button" class="btn btn-outline-primary btn-control me-2" onclick="makeMove('left')">
                                        ‚Üê –í–ª–µ–≤–æ
                                    </button>
                                    
                                    <button type="button" class="btn btn-outline-primary btn-control" onclick="makeMove('right')">
                                        –í–ø—Ä–∞–≤–æ ‚Üí
                                    </button>
                                </div>
                                
                                <!-- –í–Ω–∏–∑ -->
                                <div>
                                    <button type="button" class="btn btn-outline-primary btn-control" onclick="makeMove('down')">
                                        ‚Üì –í–Ω–∏–∑
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    üí° –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ: 
                                    <kbd>‚Üê</kbd> <kbd>‚Üë</kbd> <kbd>‚Üí</kbd> <kbd>‚Üì</kbd>
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–π -->
                        <div class="text-center">
                            <button type="button" class="btn btn-success btn-lg" onclick="newGame()">
                                üöÄ –ù–æ–≤–∞—è –∏–≥—Ä–∞
                            </button>
                            
                            <a href="/games/2048/" class="btn btn-outline-secondary btn-lg ms-2">
                                ‚Üê –ù–∞–∑–∞–¥ –∫ –∏–≥—Ä–∞–º
                            </a>
                        </div>
                    </div>
                    
                    <!-- –ü—Ä–∞–≤–∏–ª–∞ -->
                    <div class="alert alert-info">
                        <h5>üìã –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã:</h5>
                        <ul class="mb-0">
                            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–ª–∏—Ç–æ–∫</li>
                            <li>–ü—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏ –¥–≤—É—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–ª–∏—Ç–æ–∫ –æ–Ω–∏ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ –æ–¥–Ω—É</li>
                            <li>–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ö–æ–¥–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–ª–∏—Ç–∫–∞ (2 –∏–ª–∏ 4)</li>
                            <li>–¶–µ–ª—å: —Å–æ–∑–¥–∞—Ç—å –ø–ª–∏—Ç–∫—É —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º <strong>2048</strong></li>
                            <li>–ò–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript –¥–ª—è AJAX -->
<script>
// CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö–æ–¥–∞ –≤ 2048
function makeMove(direction) {
    console.log('–•–æ–¥ 2048:', direction);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const button = document.querySelector(`[onclick*="${direction}"]`);
    if (button) {
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        button.disabled = true;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch('/games/2048/move/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ direction: direction })
    })
    .then(response => {
        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('–û—Ç–≤–µ—Ç 2048:', data);
        
        if (data.error) {
            showNotification2048(data.error, 'danger');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ
        updateGame2048(data);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.disabled = false;
            button.innerHTML = getButtonTextForDirection(direction);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (data.message) {
            showNotification2048(data.message, 'success');
        }
        
        // –ï—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
        if (data.game_state?.game_over) {
            showNotification2048('üíÄ –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É.', 'danger');
            disableMoveButtons();
        }
        
        // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ 2048
        if (data.game_state?.won) {
            showNotification2048('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 2048!', 'success');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ 2048:', error);
        showNotification2048('–û—à–∏–±–∫–∞: ' + error.message, 'danger');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.disabled = false;
            button.innerHTML = getButtonTextForDirection(direction);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è 2048
function updateGame2048(data) {
    const container = document.getElementById('gameContainer2048');
    if (!container || !data.html) {
        console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ—Ç HTML –≤ –æ—Ç–≤–µ—Ç–µ');
        return;
    }
    
    // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
    container.innerHTML = data.html;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–ª–∏—Ç–∫–∞–º
    setTimeout(() => {
        init2048Animations();
    }, 100);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è 2048
function showNotification2048(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.getElementById('gameContainer2048');
    if (container) {
        container.insertBefore(notification, container.firstChild);
        
        setTimeout(() => {
            if (notification.parentNode) {
                const bsAlert = new bootstrap.Alert(notification);
                bsAlert.close();
            }
        }, 3000);
    }
}
</script>

<style>
/* –°—Ç–∏–ª–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏) */
.game-board {
    background: #bbada0;
    border-radius: 10px;
    padding: 15px;
    margin: 0 auto;
    max-width: 500px;
}

.grid-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.grid-row {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.grid-cell {
    width: 100px;
    height: 100px;
    background: rgba(238, 228, 218, 0.35);
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.tile {
    width: 100%;
    height: 100%;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    color: #776e65;
    opacity: 0;
    transition: all 0.15s ease;
    position: absolute;
    top: 0;
    left: 0;
}

.tile-show {
    opacity: 1;
    transform: scale(1);
    animation: appear 0.2s ease;
}

@keyframes appear {
    0% { opacity: 0; transform: scale(0.5); }
    100% { opacity: 1; transform: scale(1); }
}

/* –¶–≤–µ—Ç–∞ –ø–ª–∏—Ç–æ–∫ (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏) */
.tile-2 { background: #eee4da; font-size: 2.2rem; }
.tile-4 { background: #ede0c8; font-size: 2.2rem; }
.tile-8 { background: #f2b179; color: #f9f6f2; font-size: 2rem; }
.tile-16 { background: #f59563; color: #f9f6f2; font-size: 1.9rem; }
.tile-32 { background: #f67c5f; color: #f9f6f2; font-size: 1.9rem; }
.tile-64 { background: #f65e3b; color: #f9f6f2; font-size: 1.8rem; }
.tile-128 { background: #edcf72; color: #f9f6f2; font-size: 1.7rem; box-shadow: 0 0 10px rgba(237, 207, 114, 0.5); }
.tile-256 { background: #edcc61; color: #f9f6f2; font-size: 1.7rem; box-shadow: 0 0 10px rgba(237, 204, 97, 0.5); }
.tile-512 { background: #edc850; color: #f9f6f2; font-size: 1.7rem; box-shadow: 0 0 10px rgba(237, 200, 80, 0.5); }
.tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 1.5rem; box-shadow: 0 0 15px rgba(237, 197, 63, 0.5); }
.tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 1.5rem; box-shadow: 0 0 20px rgba(237, 194, 46, 0.7); }

/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
.btn-control {
    padding: 12px 25px;
    font-size: 1.1rem;
    margin: 5px;
    min-width: 120px;
    transition: all 0.2s ease;
    border-radius: 8px;
}

.btn-control:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-control:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-control:active:not(:disabled) {
    transform: scale(0.95);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ */
@keyframes pulse {
    0% { box-shadow: 0 0 5px rgba(255,255,255,0.3); }
    50% { box-shadow: 0 0 20px rgba(255,255,255,0.7); }
    100% { box-shadow: 0 0 5px rgba(255,255,255,0.3); }
}

.tile-128, .tile-256, .tile-512, .tile-1024, .tile-2048 {
    animation: pulse 2s infinite;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .game-board {
        padding: 10px;
        max-width: 100%;
    }
    
    .grid-cell {
        width: 70px;
        height: 70px;
    }
    
    .tile {
        font-size: 1.5rem;
    }
    
    .tile-2, .tile-4 { font-size: 1.6rem; }
    .tile-8, .tile-16, .tile-32 { font-size: 1.4rem; }
    .tile-64, .tile-128, .tile-256, .tile-512 { font-size: 1.3rem; }
    .tile-1024, .tile-2048, .tile-4096, .tile-8192 { font-size: 1.1rem; }
    
    .btn-control {
        padding: 10px 15px;
        min-width: 90px;
        font-size: 0.9rem;
    }
    
    .btn-lg {
        padding: 10px 20px;
        font-size: 1rem;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.alert {
    border-radius: 10px;
    margin-bottom: 15px;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∞–≤–∏—à */
kbd {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.9em;
    font-family: monospace;
    box-shadow: 0 2px 0 #dee2e6;
}
</style>

{% endblock %}